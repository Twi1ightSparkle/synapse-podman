# Synapse Podman

Quickly spin up a Synapse and friends in Podman for testing.

Currently supported services:

-   [Synapse](https://element-hq.github.io/synapse/latest/) with Postgres
    database
-   [Matrix Authentication Service](https://element-hq.github.io/matrix-authentication-service/)
    with Postgres database
-   [Element Web](https://web-docs.element.dev/)
-   [Hookshot](https://matrix-org.github.io/matrix-hookshot/latest/index.html)
-   [Adminer](https://www.adminer.org/en/)
-   [Synapse Admin](https://github.com/etkecc/synapse-admin)

**DO NOT USE THIS SCRIPT IN PRODUCTION**

**The config generated by this script is intentionally insecure to make testing
easier. Do not expose the environment to the internet**

```bash
$ ./synapse-env-manager.sh help
Usage: /path/to/synapse-env-manager.sh <option>

Options:
    admin:      Create Synapse admin account (username: admin. password: admin).
    comp:       Create MAS compatibility admin token for user admin.
    delete:     Delete the environment, Synapse/Postgres data, and config files.
    gencom:     Regenerate the Podman Compose file.
    genele:     Regenerate the Element Web config file.
    genhook:    Regenerate the Hookshot config file.
    genmas:     Regenerate the Matrix-Authentication-Service config file.
    genng:      Regenerate the Nginx config file.
    gensyn:     Regenerate the Synapse config and log config files.
    help:       This help text.
    links:      Print links.
    pull:       Pull all container images.
    rsa:        Restart all containers.
    rse:        Restart the Element Web container.
    rsh:        Restart the Hookshot container.
    rsm:        Restart the Matrix-Authentication-Service container.
    rsn:        Restart the Nginx container.
    rss:        Restart the Synapse container.
    rssa:       Restart the Synapse Admin container.
    setup:      Create, edit, (re)start the environment.
    stop:       Stop the environment without deleting it.

Note: rsa and setup will recreate all containers and remove orphaned
containers. Synapse/Postgres/Hookshot/Redis data is not deleted.
```

## Setup

Optionally copy `config.example.env` to `config.env` and edit as needed. Any
setting not specified in the config file will use defaults.

Install [yq](https://mikefarah.gitbook.io/yq/) version 4.18.1 or later, podman,
and podman-compose if you don't have them.

Run `./synapse-env-manager.sh setup` to generate the environment. This will also
generate the needed config files.

The directories `synapse`, and `hookshot`, and the files `compose.yaml`,
`elementConfig.json`, `masConfig.yaml`, and `nginx.conf` will be created in the
directory where the `synapse-env-manager.sh` script is placed. If these already
exists, you may loose data stored in them.

It will take a minute after you create the database for Synapse to start
properly as it restarts a few times while Postgres initializes the database.

Run `./synapse-env-manager.sh admin` to create an admin user (username and
password: admin)  
Run `./synapse-env-manager.sh links` to print a list of all links for your
environment.

## Use port 80 instead of 8080 to access services

```bash
sudo iptables -t nat -A OUTPUT -o lo \
    -p tcp --dport 80 -j REDIRECT --to-port 8080
```

Then set this in your config.env

```env
listenPort=80
```

## MAS

MAS is enabled by default. Disable it with `enableMas=false`. You must delete
the environment after changing enabling or disabling MAS. Or migrate manually
after changing. This script do not have support for automated migration.
